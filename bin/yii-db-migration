#!/usr/bin/env php
<?php

declare(strict_types=1);

use Psr\Container\ContainerInterface;
use Symfony\Component\Console\Application;
use Yiisoft\Aliases\Aliases;
use Yiisoft\Db\Connection\ConnectionInterface;
use Yiisoft\Db\Migration\Command\CreateCommand;
use Yiisoft\Db\Migration\Command\DownCommand;
use Yiisoft\Db\Migration\Command\HistoryCommand;
use Yiisoft\Db\Migration\Command\NewCommand;
use Yiisoft\Db\Migration\Command\RedoCommand;
use Yiisoft\Db\Migration\Command\UpdateCommand;
use Yiisoft\Db\Migration\Informer\ConsoleMigrationInformer;
use Yiisoft\Db\Migration\Migrator;
use Yiisoft\Db\Migration\Runner\DownRunner;
use Yiisoft\Db\Migration\Runner\UpdateRunner;
use Yiisoft\Db\Migration\Service\Generate\CreateService;
use Yiisoft\Db\Migration\Service\MigrationService;
use Yiisoft\Injector\Injector;

$rootPath = dirname(__DIR__, 4);

/** @psalm-suppress UnresolvableInclude, MissingFile */
require $_composer_autoload_path ?? $rootPath . '/vendor/autoload.php';

/**
 * @psalm-suppress MissingFile
 * @psalm-var array{
 *     container: ContainerInterface|null,
 *     db: ConnectionInterface|null,
 *     useTablePrefix: bool,
 *     historyTable: string,
 *     migrationNameLimit: int|null,
 *     maxSqlOutputLength: int|null,
 *     createNamespace: string,
 *     createPath: string,
 *     updateNamespaces: list<string>,
 *     updatePaths: list<string>,
 * } $params
 */
$params = require $rootPath . '/yii-db-migration.php';

$db = $params['db'] ?? throw new LogicException('DB connection is not configured.');

$aliases = new Aliases();
$injector = new Injector($params['container']);
$migrationInformer = new ConsoleMigrationInformer();
$migrator = new Migrator(
    $db,
    $migrationInformer,
    $params['historyTable'],
    $params['migrationNameLimit'],
    $params['maxSqlOutputLength']
);
$createService = new CreateService($aliases, $db, $params['useTablePrefix']);
$downRunner = new DownRunner($migrator);
$updateRunner = new UpdateRunner($migrator);

$migrationService = new MigrationService($aliases, $db, $injector, $migrator);
$migrationService->setCreateNamespace($params['createNamespace']);
$migrationService->setCreatePath($params['createPath']);
$migrationService->setUpdateNamespaces($params['updateNamespaces']);
$migrationService->setUpdatePaths($params['updatePaths']);

$createCommand = new CreateCommand($createService, $migrationService, $migrator);
$downCommand = new DownCommand($downRunner, $migrationService, $migrator);
$historyCommand = new HistoryCommand($migrationService, $migrator);
$newCommand = new NewCommand($migrationService, $migrator);
$redoCommand = new RedoCommand($migrationService, $migrator, $downRunner, $updateRunner);
$updateCommand = new UpdateCommand($updateRunner, $migrationService, $migrator);

$application = new Application('Yii Database Migration Tool', '1.0.0');
$application->addCommands([
    $createCommand,
    $downCommand,
    $historyCommand,
    $newCommand,
    $redoCommand,
    $updateCommand,
]);

$application->run();
